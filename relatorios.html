<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatórios Gerenciais - Burger House</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #ff6b35;
            --secondary-color: #f7931e;
            --success-color: #28a745;
            --info-color: #17a2b8;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --dark-color: #343a40;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background: linear-gradient(135deg, #fff, #f8f9fa);
            border-bottom: 2px solid var(--primary-color);
            border-radius: 15px 15px 0 0 !important;
            font-weight: bold;
            color: var(--dark-color);
        }
        
        .metric-card {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            text-align: center;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .filter-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .btn-export {
            background: var(--success-color);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        .btn-export:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        
        .spinner-border {
            color: var(--primary-color);
        }
        
        .breadcrumb {
            background: transparent;
            padding: 0;
        }
        
        .breadcrumb-item.active {
            color: var(--primary-color);
        }
        
        .table {
            border-radius: 10px;
            overflow: hidden;
        }
        
        .table thead th {
            background: var(--primary-color);
            color: white;
            border: none;
            font-weight: 600;
        }
        
        .table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .alert {
            border: none;
            border-radius: 10px;
        }
        
        .nav-tabs .nav-link {
            border: none;
            color: var(--dark-color);
            background: transparent;
            border-radius: 10px 10px 0 0;
            margin-right: 5px;
        }
        
        .nav-tabs .nav-link.active {
            background: var(--primary-color);
            color: white;
        }
        
        @media (max-width: 768px) {
            .metric-value {
                font-size: 1.8rem;
            }
            
            .chart-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- Navegação -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-line"></i> Relatórios Gerenciais
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="painel_dono.php">
                            <i class="fas fa-arrow-left"></i> Voltar ao Painel
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="painel_dono.php">Painel</a></li>
                <li class="breadcrumb-item active">Relatórios</li>
            </ol>
        </nav>

        <!-- Filtros -->
        <div class="filter-card">
            <div class="row">
                <div class="col-md-3">
                    <label for="dataInicio" class="form-label">Data Início</label>
                    <input type="date" class="form-control" id="dataInicio" value="">
                </div>
                <div class="col-md-3">
                    <label for="dataFim" class="form-label">Data Fim</label>
                    <input type="date" class="form-control" id="dataFim" value="">
                </div>
                <div class="col-md-3">
                    <label for="agrupamento" class="form-label">Agrupamento</label>
                    <select class="form-select" id="agrupamento">
                        <option value="dia">Por Dia</option>
                        <option value="semana">Por Semana</option>
                        <option value="mes">Por Mês</option>
                        <option value="ano">Por Ano</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-primary me-2" onclick="atualizarDados()">
                        <i class="fas fa-refresh"></i> Atualizar
                    </button>
                    <div class="dropdown">
                        <button class="btn btn-success dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="exportarRelatorio('faturamento', 'excel')">
                                <i class="fas fa-file-excel"></i> Faturamento (Excel)
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportarRelatorio('faturamento', 'pdf')">
                                <i class="fas fa-file-pdf"></i> Faturamento (PDF)
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="exportarRelatorio('produtos', 'excel')">
                                <i class="fas fa-file-excel"></i> Produtos (Excel)
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportarRelatorio('funcionarios', 'excel')">
                                <i class="fas fa-file-excel"></i> Funcionários (Excel)
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Métricas Principais -->
        <div class="row" id="metricas">
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value" id="totalPedidos">-</div>
                    <div class="metric-label">Total de Pedidos</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card" style="background: linear-gradient(135deg, var(--success-color), #20c997);">
                    <div class="metric-value" id="faturamento">-</div>
                    <div class="metric-label">Faturamento</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card" style="background: linear-gradient(135deg, var(--info-color), #20c997);">
                    <div class="metric-value" id="ticketMedio">-</div>
                    <div class="metric-label">Ticket Médio</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card" style="background: linear-gradient(135deg, var(--warning-color), #fd7e14);">
                    <div class="metric-value" id="taxaEntrega">-</div>
                    <div class="metric-label">Taxa de Entrega</div>
                </div>
            </div>
        </div>

        <!-- Abas de Relatórios -->
        <ul class="nav nav-tabs" id="relatorioTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="faturamento-tab" data-bs-toggle="tab" data-bs-target="#faturamento" type="button">
                    <i class="fas fa-chart-line"></i> Faturamento
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="produtos-tab" data-bs-toggle="tab" data-bs-target="#produtos" type="button">
                    <i class="fas fa-hamburger"></i> Produtos
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="horarios-tab" data-bs-toggle="tab" data-bs-target="#horarios" type="button">
                    <i class="fas fa-clock"></i> Horários de Pico
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="funcionarios-tab" data-bs-toggle="tab" data-bs-target="#funcionarios" type="button">
                    <i class="fas fa-users"></i> Funcionários
                </button>
            </li>
        </ul>

        <div class="tab-content" id="relatorioTabContent">
            <!-- Aba Faturamento -->
            <div class="tab-pane fade show active" id="faturamento" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-line"></i> Evolução do Faturamento
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="chartFaturamento"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aba Produtos -->
            <div class="tab-pane fade" id="produtos" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-hamburger"></i> Produtos Mais Vendidos
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="chart-container">
                                    <canvas id="chartProdutos"></canvas>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6>Top 10 Produtos</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm" id="tabelaProdutos">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Produto</th>
                                                <th>Vendidos</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aba Horários -->
            <div class="tab-pane fade" id="horarios" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-clock"></i> Análise de Horários de Pico
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="chartHorarios"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aba Funcionários -->
            <div class="tab-pane fade" id="funcionarios" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-users"></i> Desempenho dos Funcionários
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table" id="tabelaFuncionarios">
                                <thead>
                                    <tr>
                                        <th>Funcionário</th>
                                        <th>Cargo</th>
                                        <th>Pedidos Finalizados</th>
                                        <th>Eficiência</th>
                                        <th>Faturamento Gerado</th>
                                        <th>Tempo Médio</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-3">Carregando relatórios...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Variáveis globais para os gráficos
        let chartFaturamento, chartProdutos, chartHorarios;
        
        // Inicializar datas padrão (último mês)
        document.addEventListener('DOMContentLoaded', function() {
            const hoje = new Date();
            const primeiroDia = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            
            document.getElementById('dataInicio').value = primeiroDia.toISOString().split('T')[0];
            document.getElementById('dataFim').value = hoje.toISOString().split('T')[0];
            
            // Carregar dados iniciais
            atualizarDados();
        });
        
        // Função principal para atualizar todos os dados
        async function atualizarDados() {
            mostrarLoading(true);
            
            try {
                const dataInicio = document.getElementById('dataInicio').value;
                const dataFim = document.getElementById('dataFim').value;
                const agrupamento = document.getElementById('agrupamento').value;
                
                // Buscar dados do dashboard
                const response = await fetch(`relatorios_gerenciais.php?action=dashboard&data_inicio=${dataInicio}&data_fim=${dataFim}&agrupamento=${agrupamento}`);
                const data = await response.json();
                
                if (data.erro) {
                    throw new Error(data.erro);
                }
                
                // Atualizar métricas
                atualizarMetricas(data.resumo);
                
                // Atualizar gráficos
                atualizarGraficoFaturamento(data.faturamento_diario);
                atualizarGraficoProdutos(data.produtos_top);
                atualizarGraficoHorarios(data.horarios_pico);
                
                // Atualizar tabelas
                atualizarTabelaProdutos(data.produtos_top);
                atualizarTabelaFuncionarios(data.funcionarios);
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                alert('Erro ao carregar relatórios: ' + error.message);
            } finally {
                mostrarLoading(false);
            }
        }
        
        // Atualizar métricas do dashboard
        function atualizarMetricas(resumo) {
            document.getElementById('totalPedidos').textContent = resumo.total_pedidos || 0;
            document.getElementById('faturamento').textContent = 'R$ ' + (resumo.faturamento_liquido || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2});
            document.getElementById('ticketMedio').textContent = 'R$ ' + (resumo.ticket_medio || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2});
            document.getElementById('taxaEntrega').textContent = (resumo.taxa_entrega || 0) + '%';
        }
        
        // Atualizar gráfico de faturamento
        function atualizarGraficoFaturamento(dados) {
            const ctx = document.getElementById('chartFaturamento').getContext('2d');
            
            if (chartFaturamento) {
                chartFaturamento.destroy();
            }
            
            chartFaturamento = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dados.map(d => d.periodo_formatado),
                    datasets: [{
                        label: 'Faturamento Líquido',
                        data: dados.map(d => d.faturamento_liquido),
                        borderColor: 'rgb(255, 107, 53)',
                        backgroundColor: 'rgba(255, 107, 53, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Ticket Médio',
                        data: dados.map(d => d.ticket_medio),
                        borderColor: 'rgb(23, 162, 184)',
                        backgroundColor: 'rgba(23, 162, 184, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Faturamento (R$)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Ticket Médio (R$)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Evolução do Faturamento e Ticket Médio'
                        }
                    }
                }
            });
        }
        
        // Atualizar gráfico de produtos
        function atualizarGraficoProdutos(dados) {
            const ctx = document.getElementById('chartProdutos').getContext('2d');
            
            if (chartProdutos) {
                chartProdutos.destroy();
            }
            
            const top10 = dados.slice(0, 10);
            
            chartProdutos = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: top10.map(d => d.nome),
                    datasets: [{
                        data: top10.map(d => d.total_vendido),
                        backgroundColor: [
                            '#FF6B35', '#F7931E', '#28A745', '#17A2B8', '#FFC107',
                            '#DC3545', '#6F42C1', '#20C997', '#FD7E14', '#6C757D'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribuição de Vendas por Produto'
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Atualizar gráfico de horários
        function atualizarGraficoHorarios(dados) {
            const ctx = document.getElementById('chartHorarios').getContext('2d');
            
            if (chartHorarios) {
                chartHorarios.destroy();
            }
            
            chartHorarios = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dados.map(d => d.hora_formatada),
                    datasets: [{
                        label: 'Pedidos por Hora',
                        data: dados.map(d => d.total_pedidos),
                        backgroundColor: dados.map(d => d.eh_pico ? '#FF6B35' : '#17A2B8'),
                        borderColor: dados.map(d => d.eh_pico ? '#E55A2B' : '#138496'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Número de Pedidos'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Hora do Dia'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribuição de Pedidos por Horário'
                        },
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // Atualizar tabela de produtos
        function atualizarTabelaProdutos(dados) {
            const tbody = document.querySelector('#tabelaProdutos tbody');
            tbody.innerHTML = '';
            
            dados.slice(0, 10).forEach((produto, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><span class="badge bg-primary">${index + 1}</span></td>
                    <td>${produto.nome}</td>
                    <td><strong>${produto.total_vendido}</strong></td>
                `;
            });
        }
        
        // Atualizar tabela de funcionários
        function atualizarTabelaFuncionarios(dados) {
            const tbody = document.querySelector('#tabelaFuncionarios tbody');
            tbody.innerHTML = '';
            
            dados.forEach(funcionario => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${funcionario.nome}</td>
                    <td><span class="badge bg-info">${funcionario.cargo}</span></td>
                    <td><strong>${funcionario.pedidos_finalizados}</strong></td>
                    <td>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar" role="progressbar" style="width: ${funcionario.eficiencia}%">
                                ${funcionario.eficiencia}%
                            </div>
                        </div>
                    </td>
                    <td>R$ ${parseFloat(funcionario.faturamento_gerado).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td>${Math.round(funcionario.tempo_medio_preparo)} min</td>
                `;
            });
        }
        
        // Exportar relatório
        async function exportarRelatorio(tipo, formato) {
            mostrarLoading(true);
            
            try {
                const dataInicio = document.getElementById('dataInicio').value;
                const dataFim = document.getElementById('dataFim').value;
                const agrupamento = document.getElementById('agrupamento').value;
                
                const response = await fetch(`relatorios_gerenciais.php?action=exportar&tipo=${tipo}&formato=${formato}&data_inicio=${dataInicio}&data_fim=${dataFim}&agrupamento=${agrupamento}`);
                const data = await response.json();
                
                if (data.sucesso) {
                    // Criar link de download
                    const link = document.createElement('a');
                    link.href = data.arquivo;
                    link.download = data.arquivo.split('/').pop();
                    link.click();
                } else {
                    alert('Erro ao exportar relatório: ' + data.erro);
                }
            } catch (error) {
                console.error('Erro ao exportar:', error);
                alert('Erro ao exportar relatório');
            } finally {
                mostrarLoading(false);
            }
        }
        
        // Mostrar/ocultar loading
        function mostrarLoading(mostrar) {
            const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
            if (mostrar) {
                modal.show();
            } else {
                modal.hide();
            }
        }
    </script>
</body>
</html>